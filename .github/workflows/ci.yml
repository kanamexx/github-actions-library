name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect project files
        id: detect
        run: |
          has_node=false
          has_python=false
          has_docker=false
          if [ -f package.json ]; then has_node=true; fi
          if [ -f pyproject.toml ] || [ -f setup.py ] || [ -f requirements.txt ]; then has_python=true; fi
          if [ -f Dockerfile ]; then has_docker=true; fi
          echo "has_node=$has_node" >> $GITHUB_OUTPUT
          echo "has_python=$has_python" >> $GITHUB_OUTPUT
          echo "has_docker=$has_docker" >> $GITHUB_OUTPUT

      # Node.js steps
      - name: Setup Node.js
        if: steps.detect.outputs.has_node == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies (npm)
        if: steps.detect.outputs.has_node == 'true'
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm install; fi

      - name: Run tests (npm)
        if: steps.detect.outputs.has_node == 'true'
        run: |
          if grep -q '"test"' package.json; then npm test; else echo "No test script defined in package.json"; fi

      # Python steps
      - name: Setup Python
        if: steps.detect.outputs.has_python == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies (pip)
        if: steps.detect.outputs.has_python == 'true'
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then python -m pip install -r requirements.txt; fi
          # try to install poetry if pyproject exists (best-effort)
          if [ -f pyproject.toml ]; then python -m pip install poetry || true; fi

      - name: Run tests (pytest)
        if: steps.detect.outputs.has_python == 'true'
        run: |
          if [ -d tests ] || ls test_*.py >/dev/null 2>&1; then pytest; else echo "No pytest tests found"; fi

      # Docker steps
      - name: Build Docker image
        if: steps.detect.outputs.has_docker == 'true'
        run: docker build -t repo-ci-image:latest .

      - name: Nothing detected
        if: steps.detect.outputs.has_node != 'true' && steps.detect.outputs.has_python != 'true' && steps.detect.outputs.has_docker != 'true'
        run: |
          echo "No supported project files found (package.json, pyproject.toml/setup.py/requirements.txt, Dockerfile)."
          echo "Edit .github/workflows/ci.yml to add steps for your project."
